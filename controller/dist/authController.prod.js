"use strict";var _require=require("util"),promisify=_require.promisify,crypto=require("crypto"),jwt=require("jsonwebtoken"),rateLimit=require("express-rate-limit"),User=require("./../models/userModel"),catchAsync=require("./../utils/catchAsync"),AppError=require("./../utils/appError"),sendEmail=require("./../utils/email"),signToken=function(e){return jwt.sign({id:e},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN})},createSendToken=function(e,r,t){var n=signToken(e._id),s={expires:new Date(Date.now()+24*process.env.JWT_COOKIE_EXPIRES_IN*60*60*1e3),httpOnly:!0};e.password=void 0,"production"===process.env.NODE_ENV&&(s.secure=!0),t.cookie("jwt",n,s),t.status(r).json({status:"success",token:n,data:{user:e}})};exports.signup=catchAsync(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(User.create(r.body));case 2:n=e.sent,createSendToken(n,201,t);case 4:case"end":return e.stop()}})}),exports.login=catchAsync(function(r,t,n){var s,a,o,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.body,a=s.email,o=s.password,a&&o){e.next=3;break}return e.abrupt("return",n(new AppError("Please provide an password and email",400)));case 3:return e.next=5,regeneratorRuntime.awrap(User.findOne({email:a}).select("+password"));case 5:if(i=e.sent,e.t0=!i,e.t0){e.next=11;break}return e.next=10,regeneratorRuntime.awrap(i.correctPassword(o,i.password));case 10:e.t0=!e.sent;case 11:if(e.t0)return e.abrupt("return",n(new AppError("Incorrect email or password",401)));e.next=13;break;case 13:createSendToken(i,200,t);case 14:case"end":return e.stop()}})}),exports.logout=function(e,r){r.cookie("jwt","loggedout",{expires:new Date(Date.now()+1e4),httpOnly:!0}),r.status(200).json({status:"success"})},exports.protect=catchAsync(function(r,t,n){var s,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.headers.authorization&&r.headers.authorization.startsWith("Bearer"))return e.next=3,regeneratorRuntime.awrap(r.headers.authorization.split(" ")[1]);e.next=6;break;case 3:s=e.sent,e.next=7;break;case 6:r.cookies.jwt&&(s=r.cookies.jwt);case 7:if(s){e.next=9;break}return e.abrupt("return",n(new AppError("You are logged Not logged in. Please Log In to get access.",401)));case 9:return e.next=11,regeneratorRuntime.awrap(promisify(jwt.verify)(s,process.env.JWT_SECRET));case 11:return a=e.sent,e.next=14,regeneratorRuntime.awrap(User.findById(a.id));case 14:if(o=e.sent){e.next=17;break}return e.abrupt("return",n(new AppError("User belonging to the token does not exist",401)));case 17:if(o.changedPasswordAfter(a.iat))return e.abrupt("return",n(new AppError("User Recently changed Password",401)));e.next=19;break;case 19:r.user=o,t.locals.user=o,n();case 22:case"end":return e.stop()}})}),exports.restrictTo=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return function(e,r,t){if(!n.includes(e.user.role))return t(new AppError("You do not have permission to perform this action",403));t()}},exports.forgotPassword=catchAsync(function(r,t,n){var s,a,o,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(User.findOne({email:r.body.email}));case 2:if(s=e.sent){e.next=5;break}return e.abrupt("return",n(new AppError("There is no user with email address.",404)));case 5:return a=s.createPasswordResetToken(),e.next=8,regeneratorRuntime.awrap(s.save({validateBeforeSave:!1}));case 8:return o="".concat(r.protocol,"://").concat(r.get("host"),"/api/v1/users/resetPassword/").concat(a),i="Forgot your password? Submit a PATCH request with your new password and passwordConfirm to: ".concat(o,".\nIf you didn't forget your password, please ignore this email!"),e.prev=10,e.next=13,regeneratorRuntime.awrap(sendEmail({email:s.email,subject:"Your password reset token (valid for 10 min)",message:i}));case 13:t.status(200).json({status:"success",message:"Token sent to email!"}),e.next=23;break;case 16:return e.prev=16,e.t0=e.catch(10),s.passwordResetToken=void 0,s.passwordResetExpires=void 0,e.next=22,regeneratorRuntime.awrap(s.save({validateBeforeSave:!1}));case 22:return e.abrupt("return",n(new AppError("There was an error sending the email. Try again later!"),500));case 23:case"end":return e.stop()}},null,null,[[10,16]])}),exports.resetPassword=catchAsync(function(r,t,n){var s,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=crypto.createHash("sha256").update(r.params.token).digest("hex"),e.next=3,regeneratorRuntime.awrap(User.findOne({passwordResetToken:s,passwordResetExpires:{$gt:Date.now()}}));case 3:if(a=e.sent){e.next=6;break}return e.abrupt("return",n(new AppError("Token is invalid or has expired",400)));case 6:return a.password=r.body.password,a.passwordConfirm=r.body.passwordConfirm,a.passwordResetExpires=void 0,a.passwordResetToken=void 0,e.next=12,regeneratorRuntime.awrap(a.save({validateBeforeSave:!1}));case 12:o=signToken(a._id),t.status(201).json({status:"success",token:o,data:{user:a}});case 14:case"end":return e.stop()}})}),exports.updatePassword=catchAsync(function(r,t,n){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(User.findById(r.user.id).select("+password"));case 2:if((s=e.sent).correctPassword(r.body.currentPassword,s.password)){e.next=5;break}return e.abrupt("return",n(new AppError("Wrong Current Password. Please Submit your request again",400)));case 5:return s.password=r.body.updatedPassword,s.passwordConfirm=r.body.updatedPassword,e.next=9,regeneratorRuntime.awrap(s.save());case 9:createSendToken(s,201,t);case 10:case"end":return e.stop()}})}),exports.limitLogin=rateLimit({max:3,windowMs:36e5,message:"Too many requests from this IP, please try again in the hour"}),exports.isLoggedIn=function(r,t,n){var s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.cookies.jwt)return e.prev=1,e.next=4,regeneratorRuntime.awrap(promisify(jwt.verify)(r.cookies.jwt,process.env.JWT_SECRET));e.next=19;break;case 4:return s=e.sent,e.next=7,regeneratorRuntime.awrap(User.findById(s.id));case 7:if(a=e.sent){e.next=10;break}return e.abrupt("return",n(new AppError("User belonging to the token does not exist",401)));case 10:if(a.changedPasswordAfter(s.iat))return e.abrupt("return",n(new AppError("User Recently changed Password",401)));e.next=12;break;case 12:return t.locals.user=a,e.abrupt("return",n());case 16:return e.prev=16,e.t0=e.catch(1),e.abrupt("return",n());case 19:n();case 20:case"end":return e.stop()}},null,null,[[1,16]])},exports.restrictTo=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return function(e,r,t){if(!n.includes(e.user.role))return t(new AppError("You do not have permission to perform this action",403));t()}};